name: JO-Bench Performance Testing

on:
  push:
    branches: [ main ]

jobs:
  jo-bench:
    name: JO-Bench on PG 17
    runs-on: ubuntu-latest

    steps:
    - name: Checkout extension code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libreadline-dev \
          zlib1g-dev \
          flex \
          bison \
          libxml2-dev \
          libxslt-dev \
          libssl-dev \
          libxml2-utils \
          xsltproc \
          ccache

    - name: Cache PostgreSQL build
      uses: actions/cache@v4
      id: pg-cache
      with:
        path: ~/postgresql
        key: ${{ runner.os }}-pg-17-jobench-${{ hashFiles('.github/workflows/jo-bench.yml') }}

    - name: Clone PostgreSQL 17
      if: steps.pg-cache.outputs.cache-hit != 'true'
      run: |
        cd ~
        git clone --depth 1 --branch REL_17_STABLE https://github.com/postgres/postgres.git postgresql

    - name: Build PostgreSQL
      if: steps.pg-cache.outputs.cache-hit != 'true'
      run: |
        cd ~/postgresql
        ./configure --prefix=$HOME/postgresql/inst --enable-debug --enable-cassert --enable-depend
        make -j$(nproc)
        make install

    - name: Add PostgreSQL to PATH
      run: |
        echo "$HOME/postgresql/inst/bin" >> $GITHUB_PATH
        echo "PG_CONFIG=$HOME/postgresql/inst/bin/pg_config" >> $GITHUB_ENV

    - name: Build and install extension
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        make USE_PGXS=1 clean
        make USE_PGXS=1
        make USE_PGXS=1 install

    - name: Cache jo-bench repository
      uses: actions/cache@v4
      id: jobench-cache
      with:
        path: ~/jo-bench
        key: ${{ runner.os }}-jobench-${{ github.run_id }}
        restore-keys: |
          ${{ runner.os }}-jobench-

    - name: Setup jo-bench repository
      run: |
        cd ~
        if [ -d "jo-bench" ]; then
          echo "jo-bench directory exists, updating..."
          cd jo-bench
          git fetch origin main || true
          git reset --hard origin/main || true
        else
          echo "Cloning jo-bench repository..."
          git clone --depth 1 https://github.com/danolivo/jo-bench.git
        fi

    - name: Initialize PostgreSQL cluster
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        initdb -D $HOME/pgdata

    - name: Configure PostgreSQL with pg_track_optimizer
      run: |
        cat >> $HOME/pgdata/postgresql.conf <<EOF
        shared_preload_libraries = 'pg_track_optimizer'
        pg_track_optimizer.mode = 'forced'
        compute_query_id = on
        max_worker_processes = 8
        max_parallel_workers = 8
        max_parallel_workers_per_gather = 4
        min_parallel_table_scan_size = 0
        min_parallel_index_scan_size = 0
        parallel_setup_cost = 0.01
        parallel_tuple_cost = 0.0001
        EOF

    - name: Start PostgreSQL
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        pg_ctl -D $HOME/pgdata -l $HOME/pgdata/logfile start
        # Wait for PostgreSQL to start
        for i in {1..30}; do
          if pg_isready -h localhost; then
            break
          fi
          sleep 1
        done
        pg_isready -h localhost

    - name: Create test database
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        createdb jobench

    - name: Load jo-bench schema
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        psql -d jobench -f ~/jo-bench/schema.sql

    - name: Create pg_track_optimizer extension
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        psql -d jobench -c "CREATE EXTENSION pg_track_optimizer;"

    - name: Load jo-bench data
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        cd ~/jo-bench
        psql -d jobench -v datadir="'$HOME/jo-bench'" -f copy.sql

    - name: Analyse tables
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        psql -d jobench -c "VACUUM ANALYZE;"

    - name: Reset pg_track_optimizer statistics
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        psql -d jobench -c "SELECT pg_track_optimizer_reset();"

    - name: Execute jo-bench queries
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        cd ~/jo-bench/queries
        echo "Executing queries..."
        for query_file in *.sql; do
          if [ -f "$query_file" ]; then
            echo "Running: $query_file"
            # Add filename comment before query and execute
            (echo "/* $query_file */"; cat "$query_file") | \
              psql -d jobench -v datadir="'$HOME/jo-bench'" > /dev/null 2>&1 || \
              echo "Query $query_file failed"
          fi
        done
        echo "All queries executed."

    - name: Export pg_track_optimizer results to CSV
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        psql -d jobench -c "\COPY (SELECT * FROM pg_track_optimizer ORDER BY avg_error DESC) TO '/tmp/pg_track_optimizer_results.csv' WITH CSV HEADER"
        echo "Results exported to CSV:"
        head -20 /tmp/pg_track_optimizer_results.csv

    - name: Show summary statistics
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        psql -d jobench -c "
          SELECT
            COUNT(*) as total_queries,
            ROUND(AVG(avg_avg)::numeric, 2) as avg_error_mean,
            ROUND(MAX(avg_avg)::numeric, 2) as max_avg_error,
            ROUND(AVG(rms_avg)::numeric, 2) as rms_error_mean,
            ROUND(AVG(twa_avg)::numeric, 2) as twa_error_mean,
            ROUND(AVG(wca_avg)::numeric, 2) as wca_error_mean,
            SUM(blks_avg) as total_blks_avg,
            SUM(nexecs) as total_executions,
            ROUND(SUM(exec_time)::numeric, 2) as total_exec_time_ms
          FROM pg_track_optimizer;
        "

    - name: Show top 10 worst queries
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        psql -d jobench -c "
          SELECT
            LEFT(query, 80) as query_preview,
            avg_avg,avg_min,avg_max,avg_cnt,avg_dev,
            rms_avg,rms_min,rms_max,rms_cnt,rms_dev,
            twa_avg,twa_min,twa_max,twa_cnt,twa_dev,
            wca_avg,wca_min,wca_max,wca_cnt,wca_dev,
            blks_avg,blks_min,blks_max,blks_cnt,blks_dev,
            evaluated_nodes, plan_nodes,
            ROUND(exec_time::numeric, 2) as exec_time_ms,
            nexecs
          FROM pg_track_optimizer
          ORDER BY avg_avg DESC
          LIMIT 10;
        "

    - name: Generate wiki page with benchmark results
      env:
        GH_TOKEN: ${{ secrets.WIKI_TOKEN }}
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"

        # Execute the benchmark query and save to temp file
        psql -d jobench -c "
          WITH
            top_avg AS (SELECT queryid FROM pg_track_optimizer ORDER BY avg_avg DESC LIMIT 10),
            top_rms AS (SELECT queryid FROM pg_track_optimizer ORDER BY rms_avg DESC LIMIT 10),
            top_twa AS (SELECT queryid FROM pg_track_optimizer ORDER BY twa_avg DESC LIMIT 10),
            top_wca AS (SELECT queryid FROM pg_track_optimizer ORDER BY wca_avg DESC LIMIT 10),
            intersection AS (
              SELECT queryid FROM top_avg
              INTERSECT
              SELECT queryid FROM top_rms
              INTERSECT
              SELECT queryid FROM top_twa
              INTERSECT
              SELECT queryid FROM top_wca
            )
          SELECT v.queryid, LEFT(v.query, 32) as query,
                 v.avg_avg, v.avg_min, v.avg_max, v.avg_cnt, v.avg_dev,
                 v.rms_avg, v.rms_min, v.rms_max, v.rms_cnt, v.rms_dev,
                 v.twa_avg, v.twa_min, v.twa_max, v.twa_cnt, v.twa_dev,
                 v.wca_avg, v.wca_min, v.wca_max, v.wca_cnt, v.wca_dev,
                 v.exec_time, v.blks_avg, v.blks_min, v.blks_max, v.blks_cnt, v.blks_dev, v.nexecs
          FROM pg_track_optimizer v
          WHERE v.queryid IN (SELECT queryid FROM intersection)
          ORDER BY v.avg_avg DESC;
        " > /tmp/benchmark_results.txt

        # Save script path and extension commit before changing directories
        SCRIPT_PATH="$(pwd)/.github/scripts/generate-wiki-page.sh"
        EXT_COMMIT=$(git rev-parse HEAD)
        chmod +x "$SCRIPT_PATH"

        # Clone wiki repository with authentication
        cd ~
        git clone https://x-access-token:${GH_TOKEN}@github.com/danolivo/pg_track_optimizer.wiki.git wiki || {
          echo "Failed to clone wiki repository. Skipping wiki update."
          exit 0
        }

        # Run wiki page generation script
        "$SCRIPT_PATH" /tmp/benchmark_results.txt ~/wiki "$EXT_COMMIT" || {
          echo "Failed to generate wiki page."
          exit 0
        }

    - name: Stop PostgreSQL
      if: always()
      run: |
        export PATH="$HOME/postgresql/inst/bin:$PATH"
        pg_ctl -D $HOME/pgdata stop || true

    - name: Upload results CSV
      uses: actions/upload-artifact@v4
      with:
        name: pg_track_optimizer_jobench_results
        path: /tmp/pg_track_optimizer_results.csv
        retention-days: 7

    - name: Upload PostgreSQL log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: postgresql_log
        path: ~/pgdata/logfile
        retention-days: 7
        if-no-files-found: ignore
